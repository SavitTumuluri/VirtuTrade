import { NextResponse } from "next/server";

const path: string = `https://api.tiingo.com/`;

const fakeData: string = `[{"date":"2025-05-01T00:00:00.000Z","close":213.32,"high":214.56,"low":208.9,"open":209.08,"volume":57365675,"adjClose":213.0572035063,"adjHigh":214.2956759062,"adjLow":208.6426486615,"adjOpen":208.8224269131,"adjVolume":57365675,"divCash":0,"splitFactor":1},{"date":"2025-05-02T00:00:00.000Z","close":205.35,"high":206.99,"low":202.16,"open":206.09,"volume":101010621,"adjClose":205.0970220327,"adjHigh":206.7350016584,"adjLow":201.9109519071,"adjOpen":205.8361104004,"adjVolume":101010621,"divCash":0,"splitFactor":1},{"date":"2025-05-05T00:00:00.000Z","close":198.89,"high":204.1,"low":198.21,"open":203.1,"volume":69018452,"adjClose":198.6449803364,"adjHigh":203.8485619521,"adjLow":197.9658180526,"adjOpen":202.8497938877,"adjVolume":69018452,"divCash":0,"splitFactor":1},{"date":"2025-05-06T00:00:00.000Z","close":198.51,"high":200.65,"low":197.02,"open":198.21,"volume":51216482,"adjClose":198.2654484719,"adjHigh":200.4028121298,"adjLow":196.7772840559,"adjOpen":197.9658180526,"adjVolume":51216482,"divCash":0,"splitFactor":1},{"date":"2025-05-07T00:00:00.000Z","close":196.25,"high":199.44,"low":193.25,"open":199.17,"volume":68616943,"adjClose":196.0082326463,"adjHigh":199.1943027719,"adjLow":193.011928453,"adjOpen":198.9246353945,"adjVolume":68616943,"divCash":0,"splitFactor":1},{"date":"2025-05-08T00:00:00.000Z","close":197.49,"high":200.05,"low":194.6796,"open":197.72,"volume":50478872,"adjClose":197.2467050462,"adjHigh":199.8035512912,"adjLow":194.4397672779,"adjOpen":197.476421701,"adjVolume":50478872,"divCash":0,"splitFactor":1},{"date":"2025-05-09T00:00:00.000Z","close":198.53,"high":200.5399,"low":197.535,"open":199,"volume":36453923,"adjClose":198.2854238332,"adjHigh":200.2928477659,"adjLow":197.2916496091,"adjOpen":198.7548448235,"adjVolume":36453923,"divCash":0,"splitFactor":1},{"date":"2025-05-12T00:00:00.000Z","close":210.79,"high":211.2679,"low":206.75,"open":210.97,"volume":63775814,"adjClose":210.79,"adjHigh":211.2679,"adjLow":206.75,"adjOpen":210.97,"adjVolume":63775814,"divCash":0.26,"splitFactor":1},{"date":"2025-05-13T00:00:00.000Z","close":212.93,"high":213.4,"low":209,"open":210.43,"volume":51909332,"adjClose":212.93,"adjHigh":213.4,"adjLow":209,"adjOpen":210.43,"adjVolume":51909332,"divCash":0,"splitFactor":1},{"date":"2025-05-14T00:00:00.000Z","close":212.33,"high":213.94,"low":210.5801,"open":212.43,"volume":49325825,"adjClose":212.33,"adjHigh":213.94,"adjLow":210.5801,"adjOpen":212.43,"adjVolume":49325825,"divCash":0,"splitFactor":1},{"date":"2025-05-15T00:00:00.000Z","close":211.45,"high":212.96,"low":209.54,"open":210.95,"volume":45029473,"adjClose":211.45,"adjHigh":212.96,"adjLow":209.54,"adjOpen":210.95,"adjVolume":45029473,"divCash":0,"splitFactor":1},{"date":"2025-05-16T00:00:00.000Z","close":211.26,"high":212.57,"low":209.77,"open":212.36,"volume":54737850,"adjClose":211.26,"adjHigh":212.57,"adjLow":209.77,"adjOpen":212.36,"adjVolume":54737850,"divCash":0,"splitFactor":1},{"date":"2025-05-19T00:00:00.000Z","close":208.78,"high":209.48,"low":204.26,"open":207.91,"volume":46140527,"adjClose":208.78,"adjHigh":209.48,"adjLow":204.26,"adjOpen":207.91,"adjVolume":46140527,"divCash":0,"splitFactor":1},{"date":"2025-05-20T00:00:00.000Z","close":206.86,"high":208.47,"low":205.03,"open":207.67,"volume":42496635,"adjClose":206.86,"adjHigh":208.47,"adjLow":205.03,"adjOpen":207.67,"adjVolume":42496635,"divCash":0,"splitFactor":1},{"date":"2025-05-21T00:00:00.000Z","close":202.09,"high":207.04,"low":200.71,"open":205.17,"volume":59211774,"adjClose":202.09,"adjHigh":207.04,"adjLow":200.71,"adjOpen":205.17,"adjVolume":59211774,"divCash":0,"splitFactor":1},{"date":"2025-05-22T00:00:00.000Z","close":201.36,"high":202.75,"low":199.7,"open":200.71,"volume":46742407,"adjClose":201.36,"adjHigh":202.75,"adjLow":199.7,"adjOpen":200.71,"adjVolume":46742407,"divCash":0,"splitFactor":1},{"date":"2025-05-23T00:00:00.000Z","close":195.27,"high":197.7,"low":193.46,"open":193.665,"volume":78432918,"adjClose":195.27,"adjHigh":197.7,"adjLow":193.46,"adjOpen":193.665,"adjVolume":78432918,"divCash":0,"splitFactor":1},{"date":"2025-05-27T00:00:00.000Z","close":200.21,"high":200.74,"low":197.43,"open":198.3,"volume":56288475,"adjClose":200.21,"adjHigh":200.74,"adjLow":197.43,"adjOpen":198.3,"adjVolume":56288475,"divCash":0,"splitFactor":1},{"date":"2025-05-28T00:00:00.000Z","close":200.42,"high":202.73,"low":199.9,"open":200.59,"volume":45339678,"adjClose":200.42,"adjHigh":202.73,"adjLow":199.9,"adjOpen":200.59,"adjVolume":45339678,"divCash":0,"splitFactor":1},{"date":"2025-05-29T00:00:00.000Z","close":199.95,"high":203.81,"low":198.51,"open":203.575,"volume":51477938,"adjClose":199.95,"adjHigh":203.81,"adjLow":198.51,"adjOpen":203.575,"adjVolume":51477938,"divCash":0,"splitFactor":1},{"date":"2025-05-30T00:00:00.000Z","close":200.85,"high":201.96,"low":196.78,"open":199.37,"volume":70819942,"adjClose":200.85,"adjHigh":201.96,"adjLow":196.78,"adjOpen":199.37,"adjVolume":70819942,"divCash":0,"splitFactor":1},{"date":"2025-06-02T00:00:00.000Z","close":201.7,"high":202.13,"low":200.12,"open":200.28,"volume":35423294,"adjClose":201.7,"adjHigh":202.13,"adjLow":200.12,"adjOpen":200.28,"adjVolume":35423294,"divCash":0,"splitFactor":1},{"date":"2025-06-03T00:00:00.000Z","close":203.27,"high":203.77,"low":200.955,"open":201.35,"volume":46381567,"adjClose":203.27,"adjHigh":203.77,"adjLow":200.955,"adjOpen":201.35,"adjVolume":46381567,"divCash":0,"splitFactor":1},{"date":"2025-06-04T00:00:00.000Z","close":202.82,"high":206.24,"low":202.1,"open":202.91,"volume":43603985,"adjClose":202.82,"adjHigh":206.24,"adjLow":202.1,"adjOpen":202.91,"adjVolume":43603985,"divCash":0,"splitFactor":1},{"date":"2025-06-05T00:00:00.000Z","close":200.63,"high":204.75,"low":200.15,"open":203.5,"volume":55221235,"adjClose":200.63,"adjHigh":204.75,"adjLow":200.15,"adjOpen":203.5,"adjVolume":55221235,"divCash":0,"splitFactor":1},{"date":"2025-06-06T00:00:00.000Z","close":203.92,"high":205.7,"low":202.05,"open":203,"volume":46607693,"adjClose":203.92,"adjHigh":205.7,"adjLow":202.05,"adjOpen":203,"adjVolume":46607693,"divCash":0,"splitFactor":1},{"date":"2025-06-09T00:00:00.000Z","close":201.45,"high":206,"low":200.02,"open":204.39,"volume":72862557,"adjClose":201.45,"adjHigh":206,"adjLow":200.02,"adjOpen":204.39,"adjVolume":72862557,"divCash":0,"splitFactor":1},{"date":"2025-06-10T00:00:00.000Z","close":202.67,"high":204.35,"low":200.57,"open":200.6,"volume":54672608,"adjClose":202.67,"adjHigh":204.35,"adjLow":200.57,"adjOpen":200.6,"adjVolume":54672608,"divCash":0,"splitFactor":1},{"date":"2025-06-11T00:00:00.000Z","close":198.78,"high":204.5,"low":198.41,"open":203.5,"volume":60989857,"adjClose":198.78,"adjHigh":204.5,"adjLow":198.41,"adjOpen":203.5,"adjVolume":60989857,"divCash":0,"splitFactor":1},{"date":"2025-06-12T00:00:00.000Z","close":199.2,"high":199.68,"low":197.3601,"open":199.08,"volume":43904635,"adjClose":199.2,"adjHigh":199.68,"adjLow":197.3601,"adjOpen":199.08,"adjVolume":43904635,"divCash":0,"splitFactor":1},{"date":"2025-06-13T00:00:00.000Z","close":196.45,"high":200.37,"low":195.7,"open":199.73,"volume":51447349,"adjClose":196.45,"adjHigh":200.37,"adjLow":195.7,"adjOpen":199.73,"adjVolume":51447349,"divCash":0,"splitFactor":1},{"date":"2025-06-16T00:00:00.000Z","close":198.42,"high":198.685,"low":196.5636,"open":197.3,"volume":43020691,"adjClose":198.42,"adjHigh":198.685,"adjLow":196.5636,"adjOpen":197.3,"adjVolume":43020691,"divCash":0,"splitFactor":1},{"date":"2025-06-17T00:00:00.000Z","close":195.64,"high":198.39,"low":195.21,"open":197.2,"volume":38856152,"adjClose":195.64,"adjHigh":198.39,"adjLow":195.21,"adjOpen":197.2,"adjVolume":38856152,"divCash":0,"splitFactor":1},{"date":"2025-06-18T00:00:00.000Z","close":196.58,"high":197.57,"low":195.07,"open":195.94,"volume":45394689,"adjClose":196.58,"adjHigh":197.57,"adjLow":195.07,"adjOpen":195.94,"adjVolume":45394689,"divCash":0,"splitFactor":1},{"date":"2025-06-20T00:00:00.000Z","close":201,"high":201.7,"low":196.855,"open":198.235,"volume":96813542,"adjClose":201,"adjHigh":201.7,"adjLow":196.855,"adjOpen":198.235,"adjVolume":96813542,"divCash":0,"splitFactor":1},{"date":"2025-06-23T00:00:00.000Z","close":201.5,"high":202.3,"low":198.96,"open":201.625,"volume":55814272,"adjClose":201.5,"adjHigh":202.3,"adjLow":198.96,"adjOpen":201.625,"adjVolume":55814272,"divCash":0,"splitFactor":1},{"date":"2025-06-24T00:00:00.000Z","close":200.3,"high":203.44,"low":200.2,"open":202.59,"volume":54064033,"adjClose":200.3,"adjHigh":203.44,"adjLow":200.2,"adjOpen":202.59,"adjVolume":54064033,"divCash":0,"splitFactor":1},{"date":"2025-06-25T00:00:00.000Z","close":201.56,"high":203.67,"low":200.6201,"open":201.45,"volume":39525730,"adjClose":201.56,"adjHigh":203.67,"adjLow":200.6201,"adjOpen":201.45,"adjVolume":39525730,"divCash":0,"splitFactor":1},{"date":"2025-06-26T00:00:00.000Z","close":201,"high":202.64,"low":199.46,"open":201.43,"volume":50799121,"adjClose":201,"adjHigh":202.64,"adjLow":199.46,"adjOpen":201.43,"adjVolume":50799121,"divCash":0,"splitFactor":1},{"date":"2025-06-27T00:00:00.000Z","close":201.08,"high":203.22,"low":200,"open":201.89,"volume":73188571,"adjClose":201.08,"adjHigh":203.22,"adjLow":200,"adjOpen":201.89,"adjVolume":73188571,"divCash":0,"splitFactor":1},{"date":"2025-06-30T00:00:00.000Z","close":205.17,"high":207.39,"low":199.2607,"open":202.01,"volume":91912816,"adjClose":205.17,"adjHigh":207.39,"adjLow":199.2607,"adjOpen":202.01,"adjVolume":91912816,"divCash":0,"splitFactor":1},{"date":"2025-07-01T00:00:00.000Z","close":207.82,"high":210.1865,"low":206.1401,"open":206.665,"volume":78788867,"adjClose":207.82,"adjHigh":210.1865,"adjLow":206.1401,"adjOpen":206.665,"adjVolume":78788867,"divCash":0,"splitFactor":1},{"date":"2025-07-02T00:00:00.000Z","close":212.44,"high":213.34,"low":208.14,"open":208.91,"volume":67941811,"adjClose":212.44,"adjHigh":213.34,"adjLow":208.14,"adjOpen":208.91,"adjVolume":67941811,"divCash":0,"splitFactor":1},{"date":"2025-07-03T00:00:00.000Z","close":213.55,"high":214.65,"low":211.8101,"open":212.145,"volume":34955836,"adjClose":213.55,"adjHigh":214.65,"adjLow":211.8101,"adjOpen":212.145,"adjVolume":34955836,"divCash":0,"splitFactor":1},{"date":"2025-07-07T00:00:00.000Z","close":209.95,"high":216.23,"low":208.8,"open":212.68,"volume":50228984,"adjClose":209.95,"adjHigh":216.23,"adjLow":208.8,"adjOpen":212.68,"adjVolume":50228984,"divCash":0,"splitFactor":1},{"date":"2025-07-08T00:00:00.000Z","close":210.01,"high":211.43,"low":208.45,"open":210.1,"volume":42848928,"adjClose":210.01,"adjHigh":211.43,"adjLow":208.45,"adjOpen":210.1,"adjVolume":42848928,"divCash":0,"splitFactor":1},{"date":"2025-07-09T00:00:00.000Z","close":211.14,"high":211.33,"low":207.22,"open":209.53,"volume":48749367,"adjClose":211.14,"adjHigh":211.33,"adjLow":207.22,"adjOpen":209.53,"adjVolume":48749367,"divCash":0,"splitFactor":1},{"date":"2025-07-10T00:00:00.000Z","close":212.41,"high":213.48,"low":210.03,"open":210.505,"volume":44443635,"adjClose":212.41,"adjHigh":213.48,"adjLow":210.03,"adjOpen":210.505,"adjVolume":44443635,"divCash":0,"splitFactor":1},{"date":"2025-07-11T00:00:00.000Z","close":211.16,"high":212.13,"low":209.86,"open":210.565,"volume":39765812,"adjClose":211.16,"adjHigh":212.13,"adjLow":209.86,"adjOpen":210.565,"adjVolume":39765812,"divCash":0,"splitFactor":1},{"date":"2025-07-14T00:00:00.000Z","close":208.62,"high":210.91,"low":207.54,"open":209.925,"volume":38840111,"adjClose":208.62,"adjHigh":210.91,"adjLow":207.54,"adjOpen":209.925,"adjVolume":38840111,"divCash":0,"splitFactor":1},{"date":"2025-07-15T00:00:00.000Z","close":209.11,"high":211.89,"low":208.92,"open":209.22,"volume":42296339,"adjClose":209.11,"adjHigh":211.89,"adjLow":208.92,"adjOpen":209.22,"adjVolume":42296339,"divCash":0,"splitFactor":1},{"date":"2025-07-16T00:00:00.000Z","close":210.16,"high":212.4,"low":208.64,"open":210.295,"volume":47490532,"adjClose":210.16,"adjHigh":212.4,"adjLow":208.64,"adjOpen":210.295,"adjVolume":47490532,"divCash":0,"splitFactor":1},{"date":"2025-07-17T00:00:00.000Z","close":210.02,"high":211.8,"low":209.59,"open":210.57,"volume":48068141,"adjClose":210.02,"adjHigh":211.8,"adjLow":209.59,"adjOpen":210.57,"adjVolume":48068141,"divCash":0,"splitFactor":1},{"date":"2025-07-18T00:00:00.000Z","close":211.18,"high":211.79,"low":209.7045,"open":210.87,"volume":48974591,"adjClose":211.18,"adjHigh":211.79,"adjLow":209.7045,"adjOpen":210.87,"adjVolume":48974591,"divCash":0,"splitFactor":1},{"date":"2025-07-21T00:00:00.000Z","close":212.48,"high":215.78,"low":211.63,"open":212.1,"volume":51377434,"adjClose":212.48,"adjHigh":215.78,"adjLow":211.63,"adjOpen":212.1,"adjVolume":51377434,"divCash":0,"splitFactor":1},{"date":"2025-07-22T00:00:00.000Z","close":214.4,"high":214.95,"low":212.2301,"open":213.14,"volume":46404072,"adjClose":214.4,"adjHigh":214.95,"adjLow":212.2301,"adjOpen":213.14,"adjVolume":46404072,"divCash":0,"splitFactor":1},{"date":"2025-07-23T00:00:00.000Z","close":214.15,"high":215.15,"low":212.41,"open":215,"volume":46989301,"adjClose":214.15,"adjHigh":215.15,"adjLow":212.41,"adjOpen":215,"adjVolume":46989301,"divCash":0,"splitFactor":1},{"date":"2025-07-24T00:00:00.000Z","close":213.76,"high":215.69,"low":213.53,"open":213.9,"volume":46022620,"adjClose":213.76,"adjHigh":215.69,"adjLow":213.53,"adjOpen":213.9,"adjVolume":46022620,"divCash":0,"splitFactor":1},{"date":"2025-07-25T00:00:00.000Z","close":213.88,"high":215.24,"low":213.4,"open":214.7,"volume":40268781,"adjClose":213.88,"adjHigh":215.24,"adjLow":213.4,"adjOpen":214.7,"adjVolume":40268781,"divCash":0,"splitFactor":1},{"date":"2025-07-28T00:00:00.000Z","close":214.05,"high":214.845,"low":213.06,"open":214.03,"volume":37858017,"adjClose":214.05,"adjHigh":214.845,"adjLow":213.06,"adjOpen":214.03,"adjVolume":37858017,"divCash":0,"splitFactor":1},{"date":"2025-07-29T00:00:00.000Z","close":211.27,"high":214.81,"low":210.82,"open":214.175,"volume":51411723,"adjClose":211.27,"adjHigh":214.81,"adjLow":210.82,"adjOpen":214.175,"adjVolume":51411723,"divCash":0,"splitFactor":1},{"date":"2025-07-30T00:00:00.000Z","close":209.05,"high":212.39,"low":207.72,"open":211.895,"volume":45512514,"adjClose":209.05,"adjHigh":212.39,"adjLow":207.72,"adjOpen":211.895,"adjVolume":45512514,"divCash":0,"splitFactor":1},{"date":"2025-07-31T00:00:00.000Z","close":207.57,"high":209.84,"low":207.16,"open":208.49,"volume":80698431,"adjClose":207.57,"adjHigh":209.84,"adjLow":207.16,"adjOpen":208.49,"adjVolume":80698431,"divCash":0,"splitFactor":1},{"date":"2025-08-01T00:00:00.000Z","close":202.38,"high":213.58,"low":201.5,"open":210.865,"volume":104434473,"adjClose":202.38,"adjHigh":213.58,"adjLow":201.5,"adjOpen":210.865,"adjVolume":104434473,"divCash":0,"splitFactor":1}]`;

function getTMinus90(): string {
  const today = new Date();
  const tMinus90 = new Date(today);
  tMinus90.setDate(today.getDate() - 90);

  return tMinus90.toISOString().split("T")[0];
}

// eslint-disable-next-line complexity
export async function GET(req: Request) {
  // rate limit needed.. and dictionary for caching possibly.
  if (process.env.USE_MOCK_STOCK_DATA === "true") {
    console.log("returning fake data");
    return NextResponse.json(JSON.parse(fakeData));
  }
  const { searchParams } = new URL(req.url);
  const ticker = searchParams.get("ticker");
  const mode = searchParams.get("mode");

  if (!ticker) {
    return NextResponse.json({ error: "Missing ticker" }, { status: 400 });
  }

  // Mock path for both modes
  if (process.env.USE_MOCK_STOCK_DATA === "true") {
    const arr = JSON.parse(fakeData) as Array<{ date: string; close: number }>;

    if (mode === "latest") {
      const last = arr[arr.length - 1];
      return NextResponse.json({ price: last.close, asOf: last.date, mock: true });
    }

    // historical (unchanged)
    return NextResponse.json(arr);
  }

  try {
    if (mode === "latest") {
      // Current (most recent) price (per your endpoint)
      const url = `${path}tiingo/daily/${encodeURIComponent(ticker)}/prices?token=${process.env.API_KEY}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        return NextResponse.json({ error: "Failed to fetch external API (latest)" }, { status: 500 });
      }
      const arr = await r.json(); // usually an array with 1 most-recent bar
      const bar = Array.isArray(arr) && arr.length ? arr[0] : null;
      if (!bar || typeof bar.close !== "number") {
        return NextResponse.json({ error: "Malformed latest price response" }, { status: 502 });
      }
      return NextResponse.json({ price: bar.close, asOf: bar.date });
    }

    // Historical (unchanged)
    const url =
      `${path}tiingo/daily/${encodeURIComponent(ticker)}/prices` +
      `?startDate=${getTMinus90()}` +
      `&endDate=${new Date().toISOString().split("T")[0]}` +
      `&token=${process.env.API_KEY}`;

    const result = await fetch(url);
    if (!result.ok) {
      return NextResponse.json({ error: "Failed to fetch external API" }, { status: 500 });
    }
    const data = await result.json();
    return NextResponse.json(data);
  } catch (e) {
    return NextResponse.json({ error: "Unexpected error", details: String(e) }, { status: 500 });
  }
}
